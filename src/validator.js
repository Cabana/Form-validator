// Generated by CoffeeScript 1.6.2
(function() {
  var toSentence,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
  };

  toSentence = function(array) {
    var lastWordConnector, sentence, twoWordsConnector, wordsConnector;

    wordsConnector = ", ";
    twoWordsConnector = " and ";
    lastWordConnector = ", and ";
    sentence = void 0;
    switch (array.length) {
      case 0:
        sentence = "";
        break;
      case 1:
        sentence = array[0];
        break;
      case 2:
        sentence = array[0] + twoWordsConnector + array[1];
        break;
      default:
        sentence = array.slice(0, -1).join(wordsConnector) + lastWordConnector + array[array.length - 1];
    }
    return sentence;
  };

  this.FormValidator = (function() {
    function FormValidator() {
      var key, regexes, _i, _len, _ref;

      regexes = {};
      _ref = Object.keys(this.validations);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        key = _ref[_i];
        regexes[key] = this.validations[key].regex;
      }
      this.parser = new Parser(regexes);
    }

    FormValidator.prototype.validations = {
      email: {
        regex: '.+@.+\\..+',
        errorMessage: 'Email is invalid'
      },
      tel: {
        regex: '\\d{8}',
        errorMessage: 'Telephone number is invalid'
      },
      length: {
        errorMessage: function(min, max) {
          if (max && min) {
            return "Value most be at least " + min + " and maximum " + max + " characters long";
          } else if (min) {
            return "Value most be at least " + min;
          } else if (max) {
            return "Value can't be longer than " + max;
          }
        }
      },
      wordCount: {
        errorMessage: function(min, max) {
          if (max && min) {
            return "Can't contain less than " + min + " or more than " + max + " words";
          } else if (min) {
            return "Can't contain less than " + min + " words";
          } else if (max) {
            return "Can't contain more than " + max + " words";
          }
        }
      }
    };

    FormValidator.prototype.errorMessages = [];

    FormValidator.prototype.validateInput = function(input) {
      var validationResults, validations, value;

      this.errorMessages = [];
      value = input.value;
      validations = this._generateValidations(input.dataset.validation);
      validationResults = [];
      if (validations.format) {
        validationResults.push(this._validateFormat(value, validations.format));
      }
      if (validations.length) {
        validationResults.push(this._validateLength(value, validations.length));
      }
      if (validations.wordCount) {
        validationResults.push(this._validateWordCount(value, validations.wordCount));
      }
      if (validations.required && value === '') {
        this.errorMessages.push("Can't be blank");
        validationResults.push(false);
      }
      if (validations.allowEmpty && value === '') {
        validationResults = [true];
      }
      this._setErrorMessage(input, this.errorMessages);
      if (__indexOf.call(validationResults, false) >= 0) {
        return false;
      } else {
        return true;
      }
    };

    FormValidator.prototype.defineCustomValidation = function(name, regex, errorMessage) {
      this.validations[name] = {};
      this.validations[name].regex = regex;
      this.validations[name].errorMessage = errorMessage;
      return this.parser.addDefaultValue(name, regex);
    };

    FormValidator.prototype.validateForm = function(form) {
      var input, validationResults, _i, _len, _ref;

      validationResults = [];
      _ref = form.querySelectorAll('[data-validation]');
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        input = _ref[_i];
        validationResults.push(this.validateInput(input));
      }
      if (__indexOf.call(validationResults, false) >= 0) {
        return false;
      } else {
        return true;
      }
    };

    FormValidator.prototype._setErrorMessage = function(input, messages) {
      if (input.dataset.errorMessage) {
        messages = [input.dataset.errorMessage];
      }
      return input.setAttribute('data-error-message', toSentence(messages).toLowerCase().capitalize());
    };

    FormValidator.prototype._generateValidations = function(string) {
      return this.parser.parse(string);
    };

    FormValidator.prototype._validateFormat = function(value, format) {
      var validationResults,
        _this = this;

      if (format == null) {
        format = {};
      }
      validationResults = [];
      Object.keys(format).forEach(function(key) {
        var regex, valid;

        regex = new RegExp(format[key]);
        valid = regex.test(value);
        if (!valid) {
          _this.errorMessages.push(_this.validations[key].errorMessage);
        }
        return validationResults.push(valid);
      });
      if (__indexOf.call(validationResults, false) >= 0) {
        return false;
      } else {
        return true;
      }
    };

    FormValidator.prototype._validateLength = function(value, lengths) {
      var max, min, valid, validationResults, _i, _ref, _results;

      if (lengths == null) {
        lengths = {};
      }
      validationResults = [];
      max = lengths.max;
      min = lengths.min;
      if (max && min) {
        valid = (_ref = value.length, __indexOf.call((function() {
          _results = [];
          for (var _i = min; min <= max ? _i <= max : _i >= max; min <= max ? _i++ : _i--){ _results.push(_i); }
          return _results;
        }).apply(this), _ref) >= 0);
      } else if (min) {
        valid = value.length >= min;
      } else if (max) {
        valid = value.length <= max;
      }
      validationResults.push(valid);
      if (!valid) {
        this.errorMessages.push(this.validations.length.errorMessage(min, max));
      }
      if (__indexOf.call(validationResults, false) >= 0) {
        return false;
      } else {
        return true;
      }
    };

    FormValidator.prototype._validateWordCount = function(value, lengths) {
      var max, min, valid, validationResults, wordCountRegex, _i, _ref, _results;

      if (lengths == null) {
        lengths = {};
      }
      validationResults = [];
      max = lengths.max;
      min = lengths.min;
      wordCountRegex = /[ ]+/;
      if (max && min) {
        valid = (_ref = value.split(wordCountRegex).length, __indexOf.call((function() {
          _results = [];
          for (var _i = min; min <= max ? _i <= max : _i >= max; min <= max ? _i++ : _i--){ _results.push(_i); }
          return _results;
        }).apply(this), _ref) >= 0);
      } else if (min) {
        valid = value.split(wordCountRegex).length >= min;
      } else if (max) {
        valid = value.split(wordCountRegex).length <= max;
      }
      validationResults.push(valid);
      if (!valid) {
        this.errorMessages.push(this.validations.wordCount.errorMessage(min, max));
      }
      if (__indexOf.call(validationResults, false) >= 0) {
        return false;
      } else {
        return true;
      }
    };

    return FormValidator;

  })();

}).call(this);
